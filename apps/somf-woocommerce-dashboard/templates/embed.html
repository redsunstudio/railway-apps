<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOMF KPI's Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: transparent;
            color: #333;
            line-height: 1.6;
        }

        .widget-container {
            max-width: 100%;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        /* Header with Logo */
        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        .logo {
            width: 60px;
            height: auto;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            background: #fafafa;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 12px;
            background: #fafafa;
            border: none;
            font-size: 0.8rem;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            background: #f0f0f0;
        }

        .tab-btn.active {
            color: #333;
            border-bottom-color: #D4AF37;
            background: white;
        }

        .tab-btn .badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            font-size: 0.65rem;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* KPI Cards */
        .kpi-grid {
            background: #fafafa;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .kpi-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .kpi-row:last-child {
            border-bottom: none;
        }

        .kpi-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #555;
        }

        .kpi-icon {
            width: 16px;
            height: 16px;
            opacity: 0.6;
        }

        .kpi-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
        }

        .kpi-value.currency {
            color: #2e7d32;
        }

        /* Charts Section */
        .chart-section {
            background: #fafafa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .chart-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
        }

        .chart-title svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .period-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
            cursor: pointer;
        }

        .chart-container {
            position: relative;
            height: 150px;
            width: 100%;
        }

        /* Members Table */
        .members-section {
            background: #fafafa;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid #eee;
        }

        .members-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            background: #f5f5f5;
        }

        .members-header h2 {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
        }

        .members-count {
            font-size: 0.75rem;
            color: #666;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }

        .filter-bar label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: #555;
            cursor: pointer;
        }

        .filter-bar input[type="checkbox"] {
            accent-color: #D4AF37;
        }

        .members-table {
            width: 100%;
            border-collapse: collapse;
        }

        .members-table th {
            text-align: left;
            padding: 10px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }

        .members-table td {
            padding: 10px 12px;
            font-size: 0.8rem;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .members-table tr:last-child td {
            border-bottom: none;
        }

        .members-table tr:hover {
            background: #f9f9f9;
        }

        .members-table tr.contacted {
            background: #f0f9f0;
            opacity: 0.7;
        }

        .members-table tr.contacted td {
            text-decoration: line-through;
            color: #888;
        }

        .members-table tr.contacted .checkbox-cell {
            text-decoration: none;
        }

        .member-name {
            font-weight: 500;
            color: #333;
        }

        .member-email a {
            color: #2563eb;
            text-decoration: none;
            font-size: 0.75rem;
        }

        .member-email a:hover {
            text-decoration: underline;
        }

        .member-phone a {
            color: #333;
            text-decoration: none;
            font-size: 0.75rem;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .contact-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #2e7d32;
        }

        .no-members {
            padding: 30px 15px;
            text-align: center;
            color: #666;
            font-size: 0.85rem;
        }

        /* Refresh Button */
        .refresh-section {
            text-align: center;
            margin: 20px 0;
        }

        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            background: #4a4a4a;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #333;
        }

        .refresh-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .refresh-btn svg {
            width: 14px;
            height: 14px;
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Status Bar */
        .status-bar {
            text-align: center;
            font-size: 0.65rem;
            color: #999;
            margin-bottom: 15px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 10px;
            color: #888;
            font-size: 0.75rem;
            border-top: 1px solid #eee;
            margin-top: 10px;
        }

        .footer a {
            color: #555;
            text-decoration: underline;
        }

        /* Loading State */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 8px;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 2px solid #eee;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .hidden {
            display: none !important;
        }

        /* Error State */
        .error-message {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.8rem;
        }

        /* Scrollable table container */
        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="widget-container" style="position: relative;">
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="header">
            <!-- Golden Wreath Logo -->
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#D4AF37"/>
                        <stop offset="50%" style="stop-color:#F4D03F"/>
                        <stop offset="100%" style="stop-color:#D4AF37"/>
                    </linearGradient>
                </defs>
                <path d="M30 80 Q20 60 25 40 Q30 50 35 45 Q25 55 30 70 Q35 60 40 55 Q30 65 32 75 Q38 65 45 60 Q35 70 35 78"
                      fill="url(#goldGradient)" stroke="#B8960C" stroke-width="0.5"/>
                <path d="M70 80 Q80 60 75 40 Q70 50 65 45 Q75 55 70 70 Q65 60 60 55 Q70 65 68 75 Q62 65 55 60 Q65 70 65 78"
                      fill="url(#goldGradient)" stroke="#B8960C" stroke-width="0.5"/>
                <ellipse cx="22" cy="35" rx="6" ry="12" fill="url(#goldGradient)" transform="rotate(-30 22 35)"/>
                <ellipse cx="28" cy="28" rx="5" ry="10" fill="url(#goldGradient)" transform="rotate(-15 28 28)"/>
                <ellipse cx="38" cy="22" rx="5" ry="10" fill="url(#goldGradient)" transform="rotate(5 38 22)"/>
                <ellipse cx="48" cy="18" rx="5" ry="9" fill="url(#goldGradient)" transform="rotate(20 48 18)"/>
                <ellipse cx="78" cy="35" rx="6" ry="12" fill="url(#goldGradient)" transform="rotate(30 78 35)"/>
                <ellipse cx="72" cy="28" rx="5" ry="10" fill="url(#goldGradient)" transform="rotate(15 72 28)"/>
                <ellipse cx="62" cy="22" rx="5" ry="10" fill="url(#goldGradient)" transform="rotate(-5 62 22)"/>
                <ellipse cx="52" cy="18" rx="5" ry="9" fill="url(#goldGradient)" transform="rotate(-20 52 18)"/>
            </svg>
            <h1>SOMF KPI's</h1>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
                Dashboard
            </button>
            <button class="tab-btn" data-tab="pending" onclick="switchTab('pending')">
                Pending Cancellations
                <span class="badge" id="pendingBadge">0</span>
            </button>
            <button class="tab-btn" data-tab="payments" onclick="switchTab('payments')">
                Pending Payments
                <span class="badge" id="paymentsBadge">0</span>
            </button>
        </div>

        <div id="errorMessage" class="error-message hidden"></div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-row">
                    <div class="kpi-label">
                        <svg class="kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Month To Date
                    </div>
                    <div class="kpi-value currency" id="monthlyRevenue">-</div>
                </div>

                <div class="kpi-row">
                    <div class="kpi-label">
                        <svg class="kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Revenue Prior Month
                    </div>
                    <div class="kpi-value currency" id="priorMonthRevenue">-</div>
                </div>

                <div class="kpi-row">
                    <div class="kpi-label">
                        <svg class="kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Active Members
                    </div>
                    <div class="kpi-value" id="activeMembers">-</div>
                </div>

                <div class="kpi-row">
                    <div class="kpi-label">
                        <svg class="kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Pending Cancellation
                    </div>
                    <div class="kpi-value" id="pendingCancellation">-</div>
                </div>

                <div class="kpi-row">
                    <div class="kpi-label">
                        <svg class="kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Pending Payment
                    </div>
                    <div class="kpi-value" id="pendingPayment">-</div>
                </div>

                <div class="kpi-row">
                    <div class="kpi-label">
                        <svg class="kpi-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        On Hold
                    </div>
                    <div class="kpi-value" id="onHold">-</div>
                </div>
            </div>

            <!-- Active Members Trend Chart -->
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Active Members Trend
                    </div>
                    <select class="period-select" id="membersPeriod" onchange="updateMembersChart()">
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="60">Last 60 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="membersChart"></canvas>
                </div>
            </div>

            <!-- Prior Month Revenue Trend Chart -->
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Prior Month Revenue Trend
                    </div>
                    <select class="period-select" id="revenuePeriod" onchange="updateRevenueChart()">
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="60">Last 60 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Pending Cancellations Tab -->
        <div id="pendingTab" class="tab-content">
            <div class="members-section">
                <div class="members-header">
                    <h2>Members Pending Cancellation</h2>
                    <span class="members-count" id="membersCount">Loading...</span>
                </div>
                <div class="filter-bar">
                    <label>
                        <input type="checkbox" id="hideContacted" onchange="filterMembers()">
                        Hide contacted members
                    </label>
                </div>
                <div class="table-scroll">
                    <table class="members-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">Done</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                            <tr>
                                <td colspan="4" class="no-members">Loading members...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pending Payments Tab -->
        <div id="paymentsTab" class="tab-content">
            <div class="members-section">
                <div class="members-header">
                    <h2>Members with Pending Payments</h2>
                    <span class="members-count" id="paymentsCount">Loading...</span>
                </div>
                <div class="filter-bar">
                    <label>
                        <input type="checkbox" id="hideContactedPayments" onchange="filterPaymentMembers()">
                        Hide contacted members
                    </label>
                </div>
                <div class="table-scroll">
                    <table class="members-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">Done</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <tr>
                                <td colspan="4" class="no-members">Loading members...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Refresh Button -->
        <div class="refresh-section">
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">
            Loading...
        </div>

        <!-- Footer -->
        <div class="footer">
            Powered by John Isaacson Digital<br>
            Need a web tool? speak to <a href="mailto:john@johnisaacson.com" target="_blank">John</a>!
        </div>
    </div>

    <script>
        // Get API base URL from parent or use relative
        const API_BASE = window.SOMF_API_BASE || '';

        // Chart instances
        let membersChart = null;
        let revenueChart = null;

        // State
        let lastUpdated = null;
        let lastApiSync = null;
        let dataSource = 'loading';
        let pendingMembers = [];
        let pendingPaymentMembers = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadAllData();
            setInterval(loadAllData, 5 * 60 * 1000);
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'dashboard') {
                document.getElementById('dashboardTab').classList.add('active');
            } else if (tabName === 'pending') {
                document.getElementById('pendingTab').classList.add('active');
                loadPendingCancellations();
            } else if (tabName === 'payments') {
                document.getElementById('paymentsTab').classList.add('active');
                loadPendingPayments();
            }
        }

        function initCharts() {
            const membersCtx = document.getElementById('membersChart').getContext('2d');
            membersChart = new Chart(membersCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Active Members',
                        data: [],
                        borderColor: '#4F4F4F',
                        backgroundColor: 'rgba(79, 79, 79, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointBackgroundColor: '#4F4F4F'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { beginAtZero: false, grid: { color: '#eee' }, ticks: { font: { size: 10 } } }
                    }
                }
            });

            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue',
                        data: [],
                        borderColor: '#2E7D32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        pointBackgroundColor: '#2E7D32'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: {
                            beginAtZero: false,
                            grid: { color: '#eee' },
                            ticks: { font: { size: 10 }, callback: (v) => '£' + v.toLocaleString() }
                        }
                    }
                }
            });
        }

        async function loadAllData() {
            try {
                await Promise.all([
                    loadMetrics(),
                    updateMembersChart(),
                    updateRevenueChart(),
                    loadPendingCancellations(),
                    loadPendingPayments()
                ]);
            } catch (error) {
                showError('Failed to load data');
            } finally {
                hideLoading();
            }
        }

        async function loadMetrics() {
            const response = await fetch(API_BASE + '/api/metrics');
            const result = await response.json();
            if (result.success) {
                const data = result.data;
                document.getElementById('monthlyRevenue').textContent = data.monthly_revenue || '£0.00';
                document.getElementById('priorMonthRevenue').textContent = data.prior_month_revenue || '£0.00';
                document.getElementById('activeMembers').textContent = data.active || 0;
                document.getElementById('pendingCancellation').textContent = data['pending-cancel'] || 0;
                document.getElementById('pendingPayment').textContent = data.pending || 0;
                document.getElementById('onHold').textContent = data['on-hold'] || 0;
                lastUpdated = result.last_updated;
                lastApiSync = data.last_api_connection;
                dataSource = result.source;
                updateStatusBar();
                hideError();
            }
        }

        async function loadPendingCancellations() {
            try {
                const response = await fetch(API_BASE + '/api/pending-cancellations');
                const result = await response.json();
                if (result.success) {
                    pendingMembers = result.data;
                    updatePendingBadge();
                    renderMembersTable();
                }
            } catch (error) {
                console.error('Error loading pending cancellations:', error);
            }
        }

        function updatePendingBadge() {
            const badge = document.getElementById('pendingBadge');
            const notContacted = pendingMembers.filter(m => !m.contacted).length;
            badge.textContent = notContacted;
            badge.style.display = notContacted > 0 ? 'inline-block' : 'none';
        }

        function renderMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            const countEl = document.getElementById('membersCount');
            const hideContacted = document.getElementById('hideContacted').checked;

            let filteredMembers = pendingMembers;
            if (hideContacted) {
                filteredMembers = pendingMembers.filter(m => !m.contacted);
            }

            const notContactedCount = pendingMembers.filter(m => !m.contacted).length;
            countEl.textContent = `${notContactedCount} not contacted / ${pendingMembers.length} total`;

            if (filteredMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-members">No members pending cancellation</td></tr>';
                return;
            }

            tbody.innerHTML = filteredMembers.map(member => `
                <tr class="${member.contacted ? 'contacted' : ''}" data-id="${member.subscription_id}">
                    <td class="checkbox-cell">
                        <input type="checkbox"
                               class="contact-checkbox"
                               ${member.contacted ? 'checked' : ''}
                               onchange="toggleContacted(${member.subscription_id}, this.checked)"
                               title="Mark as contacted">
                    </td>
                    <td>
                        <div class="member-name">${escapeHtml(member.first_name)} ${escapeHtml(member.last_name)}</div>
                    </td>
                    <td class="member-email">
                        <a href="mailto:${escapeHtml(member.email)}">${escapeHtml(member.email)}</a>
                    </td>
                    <td class="member-phone">
                        ${member.phone ? `<a href="tel:${escapeHtml(member.phone)}">${escapeHtml(member.phone)}</a>` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function filterMembers() {
            renderMembersTable();
        }

        async function loadPendingPayments() {
            try {
                const response = await fetch(API_BASE + '/api/pending-payments');
                const result = await response.json();
                if (result.success) {
                    pendingPaymentMembers = result.data;
                    updatePaymentsBadge();
                    renderPaymentsTable();
                }
            } catch (error) {
                console.error('Error loading pending payments:', error);
            }
        }

        function updatePaymentsBadge() {
            const badge = document.getElementById('paymentsBadge');
            const notContacted = pendingPaymentMembers.filter(m => !m.contacted).length;
            badge.textContent = notContacted;
            badge.style.display = notContacted > 0 ? 'inline-block' : 'none';
        }

        function renderPaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            const countEl = document.getElementById('paymentsCount');
            const hideContacted = document.getElementById('hideContactedPayments').checked;

            let filteredMembers = pendingPaymentMembers;
            if (hideContacted) {
                filteredMembers = pendingPaymentMembers.filter(m => !m.contacted);
            }

            const notContactedCount = pendingPaymentMembers.filter(m => !m.contacted).length;
            countEl.textContent = `${notContactedCount} not contacted / ${pendingPaymentMembers.length} total`;

            if (filteredMembers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-members">No members with pending payments</td></tr>';
                return;
            }

            tbody.innerHTML = filteredMembers.map(member => `
                <tr class="${member.contacted ? 'contacted' : ''}" data-id="${member.subscription_id}" data-type="payment">
                    <td class="checkbox-cell">
                        <input type="checkbox"
                               class="contact-checkbox"
                               ${member.contacted ? 'checked' : ''}
                               onchange="toggleContactedPayment(${member.subscription_id}, this.checked)"
                               title="Mark as contacted">
                    </td>
                    <td>
                        <div class="member-name">${escapeHtml(member.first_name)} ${escapeHtml(member.last_name)}</div>
                    </td>
                    <td class="member-email">
                        <a href="mailto:${escapeHtml(member.email)}">${escapeHtml(member.email)}</a>
                    </td>
                    <td class="member-phone">
                        ${member.phone ? `<a href="tel:${escapeHtml(member.phone)}">${escapeHtml(member.phone)}</a>` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function filterPaymentMembers() {
            renderPaymentsTable();
        }

        async function toggleContacted(subscriptionId, contacted) {
            try {
                const response = await fetch(API_BASE + '/api/member/contacted', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription_id: subscriptionId,
                        contacted: contacted
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const member = pendingMembers.find(m => m.subscription_id === subscriptionId);
                    if (member) {
                        member.contacted = contacted;
                    }

                    const row = document.querySelector(`tr[data-id="${subscriptionId}"]:not([data-type])`);
                    if (row) {
                        if (contacted) {
                            row.classList.add('contacted');
                        } else {
                            row.classList.remove('contacted');
                        }
                    }

                    updatePendingBadge();

                    if (document.getElementById('hideContacted').checked && contacted) {
                        renderMembersTable();
                    }
                }
            } catch (error) {
                console.error('Error updating contacted status:', error);
                const checkbox = document.querySelector(`tr[data-id="${subscriptionId}"]:not([data-type]) .contact-checkbox`);
                if (checkbox) {
                    checkbox.checked = !contacted;
                }
            }
        }

        async function toggleContactedPayment(subscriptionId, contacted) {
            try {
                const response = await fetch(API_BASE + '/api/member/contacted', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription_id: subscriptionId,
                        contacted: contacted
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const member = pendingPaymentMembers.find(m => m.subscription_id === subscriptionId);
                    if (member) {
                        member.contacted = contacted;
                    }

                    const row = document.querySelector(`tr[data-id="${subscriptionId}"][data-type="payment"]`);
                    if (row) {
                        if (contacted) {
                            row.classList.add('contacted');
                        } else {
                            row.classList.remove('contacted');
                        }
                    }

                    updatePaymentsBadge();

                    if (document.getElementById('hideContactedPayments').checked && contacted) {
                        renderPaymentsTable();
                    }
                }
            } catch (error) {
                console.error('Error updating contacted status:', error);
                const checkbox = document.querySelector(`tr[data-id="${subscriptionId}"][data-type="payment"] .contact-checkbox`);
                if (checkbox) {
                    checkbox.checked = !contacted;
                }
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateMembersChart() {
            const days = document.getElementById('membersPeriod').value;
            const response = await fetch(API_BASE + `/api/historical-active-members?days=${days}`);
            const result = await response.json();
            if (result.success && result.data) {
                membersChart.data.labels = result.data.map(d => formatDate(d.date));
                membersChart.data.datasets[0].data = result.data.map(d => d.active_count);
                membersChart.update();
            }
        }

        async function updateRevenueChart() {
            const days = document.getElementById('revenuePeriod').value;
            const response = await fetch(API_BASE + `/api/historical-revenue?days=${days}`);
            const result = await response.json();
            if (result.success && result.data) {
                revenueChart.data.labels = result.data.map(d => formatDate(d.date));
                revenueChart.data.datasets[0].data = result.data.map(d => d.revenue);
                revenueChart.update();
            }
        }

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.classList.add('loading');
            try {
                await fetch(API_BASE + '/api/refresh', { method: 'POST' });
                await loadAllData();
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getDate()} ${date.toLocaleString('en-GB', { month: 'short' })}`;
        }

        function updateStatusBar() {
            let status = `Last updated: ${lastUpdated || 'Unknown'}`;
            if (lastApiSync) status += ` · Last API sync: ${lastApiSync}`;
            status += ` · Source: ${dataSource}`;
            document.getElementById('statusBar').textContent = status;
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    </script>
</body>
</html>
